<html>
<head>
<title>Modified tic-tac-toe</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body { height: 100%; margin: 0; } 
.container {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.header, .footer {
    overflow-x: hidden;		
    flex-grow: 0;
}

.content {
    overflow: auto;
    flex: 1;
}

body { font-family: arial, sans-serif; }
.container { margin: 0 auto; }
.content { margin: 1ex; }
.footer { margin: .5ex 1ex; text-align: end; }

.container {width: 244px;}
.fld { border-collapse: collapse; }

.fld td { width: 80px; height: 80px; border: 1px solid grey; cursor: pointer;}

.fld td.red { background-color: #faa; }
.fld td.green { background-color: #afa; }
.fld td.pale { opacity: 0.45; }
/*.fld td.win {outline: 3px solid coral; outline-offset: -1px; } */

button { font-size: 125%; margin: 1ex auto; display: block; padding: 0.3ex 0.9ex; }
.res { font-size: 150%; margin: 1.5ex auto; text-align: center; }
.copy { font-size: 85%; }


@media (width <= 480px) {
  .container { width: 100%; }	
  .fld td { width: 33vw; height: 33vw; }
}

@media (prefers-color-scheme: dark) {
  body { background-color: #222; color: #bbb; }
  a { color: #227aec; }
  .fld td { border-color: lightgrey; }
  .fld td.red { background-color: #941f1f; }
  .fld td.green { background-color: #0c890c; }
  .fld td.pale { opacity: 0.4; }

}

</style>
</head>
<body>

<div class="container">
<div class="content">
	<table class="fld">
		<tr><td></td><td></td><td></td></tr>
		<tr><td></td><td></td><td></td></tr>
		<tr><td></td><td></td><td></td></tr>
	</table>

	<button action="action" disabled>Reset</button>

	<div class="res"></div>
</div>

<div class="footer"><span class="copy">by @<a href="https://t.me/serge_ttv">serge_ttv</a></span></div>
</div>
</body>

<script>
(function() 
{
	let it = 0;
    const prev = [];
	function click(e) 
	{
		if (it == -1)
			reset();

		const tgt = e.target;
		if (tgt.classList.contains('red') || tgt.classList.contains('green'))
		    return;
		
		tgt.classList.add((++it) % 2 == 0 ? 'red' : 'green');
		prev.push(tgt);

		if (prev.length > 6) 
		{
			prev[0].classList.remove('red', 'green', 'pale');
			prev.shift();				
		}
		if (prev.length == 6) 
			prev[0].classList.add('pale')

		btn().disabled = false;

		testWin();
    }

	function testWin()
	{
		if (testSeq(document.querySelectorAll('.green')))
			celebrate(`Green wins in ${Math.floor((it + 1) / 2)} turns!`);
		if (testSeq(document.querySelectorAll('.red')))
			celebrate(`Red wins in ${Math.floor((it + 1) / 2)} turns!`);
	}

	function celebrate(msg, sequence) 
	{
		it = -1;
		const el = document.querySelector('.res');
		el.innerHTML = msg;
		el.style.display = 'block';
	}

	function testSeq(seq)
	{		
		if (!seq || seq.length != 3)
			return false;

		const acc = { er: true, ec: true, pr: -1, pc: -1, sym: 0, asym: 0 };
		const inv = Array.prototype.map.call(seq, e => {return {x: e.cellIndex, y: e.parentNode.rowIndex};})
			.reduce((a, v) => { a.er &&= v.y == a.pr || a.pr == -1; a.pr = v.y; a.ec &&= v.x == a.pc || a.pc == -1; a.pc = v.x; a.sym += (v.x == v.y ? 1 : 0); a.asym += ((v.x + v.y) == 2 ? 1 : 0); return a;}, acc);

		console.log('inv', inv);

		return inv.er || inv.ec || inv.sym == 3 || inv.asym == 3;
	}


	function reset()
	{
		it = 0;
		for (i = prev.length - 1; i >= 0; i--) 
		{
            prev[0].classList.remove('red', 'green', 'pale', 'win');
			prev.shift();
		}

		btn().disabled = true;
		document.querySelector('.res').style.display = 'none';
	}

	function btn()
	{
		return document.querySelector('button');
	}
        
	document.querySelector('table.fld').addEventListener('click', click);
	btn().addEventListener('click', reset);
}) ();

</script>
</html>
